---
- name: Load Arch package variables
  ansible.builtin.include_vars:
    file: arch.yml
  when: ansible_facts["distribution"] == "Archlinux"

- name: Load AUR package variables
  ansible.builtin.include_vars:
    file: aur.yml
  when: ansible_facts["distribution"] == "Archlinux"

- name: Load Ubuntu package variables
  ansible.builtin.include_vars:
    file: ubuntu.yml
  when: ansible_facts["distribution"] == "Ubuntu"

# Arch Linux package installation
- name: Install pacman packages (Arch Linux)
  become: true
  community.general.pacman:
    name: "{{ arch_pacman_packages }}"
    state: present
  when: ansible_facts["distribution"] == "Archlinux"

- name: Check if paru is installed
  ansible.builtin.shell: command -v paru
  register: paru_exists
  ignore_errors: true
  changed_when: false
  failed_when: false
  when: ansible_facts["distribution"] == "Archlinux"

- name: Create the aur_builder user
  become: true
  ansible.builtin.user:
    name: aur_builder
    create_home: true
    group: wheel
  when: ansible_facts["distribution"] == "Archlinux"

- name: Allow the aur_builder user to run sudo pacman without a password
  become: true
  ansible.builtin.lineinfile:
    path: /etc/sudoers.d/11-install-aur_builder
    line: 'aur_builder ALL=(ALL) NOPASSWD: /usr/bin/pacman'
    create: true
    mode: '0644'
    validate: 'visudo -cf %s'
  when: ansible_facts["distribution"] == "Archlinux"

- name: Install paru (AUR helper)
  when: 
    - ansible_facts["distribution"] == "Archlinux"
    - paru_exists.rc != 0
  block:
    - name: Install build dependencies for paru
      become: true
      community.general.pacman:
        name:
          - base-devel
          - git
          - rust
        state: present

    - name: Clone paru repository
      ansible.builtin.git:
        repo: https://aur.archlinux.org/paru.git
        dest: /tmp/paru
        version: master
        depth: 1
        force: true

    - name: Build paru
      ansible.builtin.shell: |
        cd /tmp/paru
        makepkg -sf --noconfirm
      changed_when: true

    - name: Find built paru package
      ansible.builtin.find:
        paths: /tmp/paru
        patterns: '^paru-(?!.*debug).*\.pkg\.tar\.zst$'
        use_regex: true
      register: paru_package

    - name: Debug paru package search
      ansible.builtin.debug:
        var: paru_package

    - name: Install paru package
      become: true
      community.general.pacman:
        name: "{{ paru_package.files[0].path }}"
        state: present
      when: paru_package.matched > 0

    - name: Clean up paru build files
      ansible.builtin.file:
        path: /tmp/paru
        state: absent

- name: Install AUR packages (Arch Linux)
  kewlfft.aur.aur:
    name: "{{ arch_aur_packages }}"
    use: paru
    state: present
  when: 
    - ansible_facts["distribution"] == "Archlinux"
    - arch_aur_packages | length > 0
  become: true
  become_user: aur_builder

- name: Remove aur_builder user
  become: true
  ansible.builtin.user:
    name: aur_builder
    state: absent
    remove: true
  when: ansible_facts["distribution"] == "Archlinux"

- name: Remove aur_builder sudoers file
  become: true
  ansible.builtin.file:
    path: /etc/sudoers.d/11-install-aur_builder
    state: absent
  when: ansible_facts["distribution"] == "Archlinux"

# Ubuntu package installation
- name: Install apt packages (Ubuntu)
  become: true
  ansible.builtin.apt:
    name: "{{ ubuntu_apt_packages }}"
    state: present
    update_cache: true
  when: ansible_facts["distribution"] == "Ubuntu"

- name: Install cargo packages (Ubuntu)
  community.general.cargo:
    name: "{{ item }}"
    executable: "{{ ansible_facts.env.HOME }}/.cargo/bin/cargo"
  loop: "{{ ubuntu_cargo_packages }}"
  when: ansible_facts["distribution"] == "Ubuntu"

# Common tasks
- name: Create ~/.local/bin/ directory
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.local/bin"
    state: directory
    mode: 0755

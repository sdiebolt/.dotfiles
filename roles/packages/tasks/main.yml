---
- name: Load Arch package variables
  ansible.builtin.include_vars:
    file: arch.yml
  when: ansible_facts["distribution"] == "Archlinux"

- name: Load AUR package variables
  ansible.builtin.include_vars:
    file: aur.yml
  when: ansible_facts["distribution"] == "Archlinux"

- name: Load Ubuntu package variables
  ansible.builtin.include_vars:
    file: ubuntu.yml
  when: ansible_facts["distribution"] == "Ubuntu"

# Arch Linux package installation
- name: Install pacman packages (Arch Linux)
  become: true
  community.general.pacman:
    name: "{{ arch_pacman_packages }}"
    state: present
  when: ansible_facts["distribution"] == "Archlinux"

- name: Check if paru is installed
  ansible.builtin.shell: command -v paru
  register: paru_exists
  ignore_errors: true
  changed_when: false
  failed_when: false
  when: ansible_facts["distribution"] == "Archlinux"

- name: Install paru (AUR helper)
  when: 
    - ansible_facts["distribution"] == "Archlinux"
    - paru_exists.rc != 0
  block:
    - name: Install base-devel and git for paru
      become: true
      community.general.pacman:
        name:
          - base-devel
          - git
        state: present

    - name: Clone paru repository
      ansible.builtin.git:
        repo: https://aur.archlinux.org/paru.git
        dest: /tmp/paru
        version: master
        depth: 1

    - name: Build and install paru
      ansible.builtin.shell: |
        cd /tmp/paru
        makepkg -si --noconfirm
      args:
        creates: /usr/bin/paru

    - name: Clean up paru build files
      ansible.builtin.file:
        path: /tmp/paru
        state: absent

- name: Install AUR packages (Arch Linux)
  kewlfft.aur.aur:
    name: "{{ arch_aur_packages }}"
    use: paru
    state: present
  when: 
    - ansible_facts["distribution"] == "Archlinux"
    - arch_aur_packages | length > 0
  become: true
  become_user: "{{ ansible_facts.env.USER }}"

# Ubuntu package installation
- name: Install apt packages (Ubuntu)
  become: true
  ansible.builtin.apt:
    name: "{{ ubuntu_apt_packages }}"
    state: present
    update_cache: true
  when: ansible_facts["distribution"] == "Ubuntu"

- name: Install cargo packages (Ubuntu)
  community.general.cargo:
    name: "{{ item }}"
    executable: "{{ ansible_facts.env.HOME }}/.cargo/bin/cargo"
  loop: "{{ ubuntu_cargo_packages }}"
  when: ansible_facts["distribution"] == "Ubuntu"

# Common tasks
- name: Create ~/.local/bin/ directory
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.local/bin"
    state: directory
    mode: 0755

---
- name: Install GNU Stow
  become: true
  community.general.pacman:
    name: stow
    state: present

# Handle systemd drop-in configurations separately (systemd doesn't follow symlinks)
- name: Ensure autologin drop-in directory exists
  become: true
  ansible.builtin.file:
    path: /etc/systemd/system/getty@tty1.service.d
    state: directory
    mode: '0755'

- name: Deploy autologin configuration (copy, not symlink)
  become: true
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/system-configs/autologin/systemd/system/getty@tty1.service.d/autologin.conf"
    dest: /etc/systemd/system/getty@tty1.service.d/autologin.conf
    mode: '0644'
  notify:
    - systemd daemon-reload

- name: Build system configs directories list
  ansible.builtin.find:
    paths: [system-configs/]
    recurse: no
    file_type: directory
  register: files

- name: Deploy system configuration files
  become: true
  with_items: '{{ files.files }}'
  ansible.builtin.shell: |
    STOW_PATH={{ item.path | replace("system-configs/", "") }}
    OVERRIDE_TARGET=$(cat ${STOW_PATH}/.override 2>/dev/null)
    TARGET=${OVERRIDE_TARGET:-/etc}
    stow -v -t ${TARGET} ${STOW_PATH}
  args:
    chdir: ./system-configs
    executable: /bin/bash
  loop_control:
    label: |-
      {% if output.stderr|length > 1 %}
      {{ item.path }}
      {{ output.stderr }}
      {%- else %}
      {{ item.path }}
      {%- endif %}
  register: output
  changed_when: '"LINK" in output.stderr'
